<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pantry - Pemesanan Online</title>
  <link rel="stylesheet" href="index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="navbar">
    <div class="nav-left">
      <span class="brand-name">Pantry</span>
      <img src="Pantry Primary Logo-01.png" alt="Pantry Logo" class="brand-logo"> 
    </div>
    <div class="nav-right">
      <button class="nav-btn btn-secondary" onclick="openModal('contact')">Contact Me</button>
      <button class="nav-btn btn-secondary" onclick="openModal('info')">Info</button>
      <button class="nav-btn btn-primary" onclick="redirectToCashier()">Dashboard Kasir</button>
    </div>
  </header>
  
  <div class="container">
    <div class="content-grid">
        
        <div id="menu-section">
            <h2>Menu Makanan</h2>
            <div class="menu-list" id="menu-makanan"></div>

            <h2 style="margin-top: 30px;">Menu Minuman</h2>
            <div class="menu-list" id="menu-minuman"></div>
        </div>

        <div id="cart-section">
            <div class="cart-box">
                <h3>Keranjang Belanja</h3>
                <label for="customer-name" style="font-size: 0.9em; font-weight: 600; margin-top: 10px; display: block;">Masukkan Nama Anda:</label>
                <input type="text" id="customer-name" placeholder="Nama Pelanggan" class="input-name">
                <ul id="cart-items" class="cart-items">
                    </ul>
                <div class="payment-status-info">
                    Status Pembayaran: <span id="payment-status" style="font-weight: 600;">Belum dibayar ❌</span>
                </div>
                <button id="pay-btn" class="btn-primary" onclick="openPaymentModal()" disabled>Bayar Sekarang</button>
                <button id="checkout-btn" class="btn-primary" onclick="checkout()" disabled style="background-color: #068b18;">
                    Checkout & Buat Pesanan
                </button>
            </div>
        </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2024 Pantry. All rights reserved.</p>
  </footer>

  <div id="payment-modal" class="modal">
    <div class="modal-content payment-modal-content">
      <span class="close" onclick="closeModal('payment')">&times;</span>
      <h2>Pilih Metode Pembayaran</h2>
      <p style="font-size: 1.2em; font-weight: 700; color: #d14838; margin-bottom: 20px;">Total Tagihan: <span id="payment-total-display">Rp0</span></p>
      
      <div id="payment-options" class="payment-options-grid">
        </div>

      <p style="margin-top: 30px; color: #666; font-size: 0.9em;">*Pastikan nama pelanggan sudah terisi sebelum memilih metode pembayaran.</p>
    </div>
  </div>

  <div id="info-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('info')">&times;</span>
      <h2>Informasi</h2>
      <p>Aplikasi Pemesanan & Kasir Sederhana berbasis HTML, CSS, dan JavaScript (Local Storage).</p>
    </div>
  </div>

  <div id="contact-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('contact')">&times;</span>
      <h2>Kontak</h2>
      <p>Silakan hubungi pengembang untuk informasi lebih lanjut.</p>
    </div>
  </div>

<script>
    const menuData = [
      { name: 'Nasi Goreng Spesial', price: 25000, category: 'makanan', img: 'nasgor.jpg' },
      { name: 'Mie Ayam Bakso', price: 20000, category: 'makanan', img: 'yamyam.jpg' },
      { name: 'Sate Ayam Madura', price: 30000, category: 'makanan', img: 'sate.jpg' },
      { name: 'Ayam Geprek Sambal Matah', price: 28000, category: 'makanan', img: 'ayamgeprek.jpg' },
      { name: 'Kwetiau Goreng Seafood', price: 27000, category: 'makanan', img: 'kwetiau.jpg' },
      { name: 'Soto Ayam Bening', price: 22000, category: 'makanan', img: 'soto.jpg' },
      { name: 'Beef Black Pepper', price: 35000, category: 'makanan', img: 'beefpepper.jpg' },
      { name: 'Capcay Kuah Sayur', price: 24000, category: 'makanan', img: 'capcay.jpg' },
      
      { name: 'Es Teh Manis', price: 8000, category: 'minuman', img: 'eses.jpg' },
      { name: 'Jus Alpukat', price: 15000, category: 'minuman', img: 'aalal.jpg' },
      { name: 'Kopi Susu Dingin', price: 12000, category: 'minuman', img: 'kopi.jpg' },
      { name: 'Teh Tarik Panas', price: 10000, category: 'minuman', img: 'tehtarik.jpg' },
      { name: 'Lemon Tea Dingin', price: 14000, category: 'minuman', img: 'lemontea.jpg' },
      { name: 'Milkshake Cokelat', price: 18000, category: 'minuman', img: 'milkshake.jpg' },
      { name: 'Air Mineral Botol', price: 5000, category: 'minuman', img: 'airmineral.jpg' },
      { name: 'Jus Mangga Segar', price: 16000, category: 'minuman', img: 'jusmangga.jpg' },
    ];

    const paymentMethods = [
      { name: 'QRIS (Gopay/Dana/Shopee)', img: 'qris.png', color: '#068b18' },
      { name: 'Bank Transfer (BCA)', img: 'bca.png', color: '#004A99' },
      { name: 'Tunai', img: 'cash.png', color: '#999999' },
    ];

    let cart = [];
    let currentPayment = null; // Menyimpan status pembayaran yang sedang berjalan

    document.addEventListener('DOMContentLoaded', () => {
      renderMenu();
      updateCart();
      // Muat ulang currentPayment dari localStorage saat halaman dimuat
      const lastPaymentId = sessionStorage.getItem('lastPaymentId');
      if (lastPaymentId) {
          const payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
          currentPayment = payments.find(p => p.id === lastPaymentId) || null;
      }
      setInterval(checkPaymentStatus, 2000); // cek tiap 2 detik
    });

    // Fungsi utilitas untuk memformat harga
    function formatRupiah(number) {
        return `Rp${number.toLocaleString('id-ID')}`;
    }

    function redirectToCashier() {
      const pass = prompt("Masukkan password kasir:");
      if (pass === "kasir123") {
        sessionStorage.setItem("cashierAuth", "true");
        window.location.href = "payment_dashboard.html"; // Arahkan ke payment_dashboard dulu
      } else if (pass) alert("Password salah!");
    }

    function renderMenu() {
      const makanan = document.getElementById('menu-makanan');
      const minuman = document.getElementById('menu-minuman');
      makanan.innerHTML = '';
      minuman.innerHTML = '';

      menuData.forEach(item => {
        const exist = cart.find(i => i.name === item.name);
        const qty = exist ? exist.qty : 0;
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <div class="menu-info">
            <div class="menu-name">${item.name}</div>
            <div class="menu-price">${formatRupiah(item.price)}</div>
          </div>
          <div class="menu-actions">
            <button class="btn-qty" onclick="changeMenuQty('${item.name}', ${item.price}, -1)">-</button>
            <div class="qty-display">${qty}</div>
            <button class="btn-qty btn-plus" onclick="changeMenuQty('${item.name}', ${item.price}, 1)">+</button>
          </div>
        `;
        
        if (item.category === 'makanan') {
          makanan.appendChild(div);
        } else {
          minuman.appendChild(div);
        }
      });
    }

    function changeMenuQty(name, price, change) {
      const existingItem = cart.find(item => item.name === name);

      if (existingItem) {
        existingItem.qty += change;
        if (existingItem.qty <= 0) {
          cart = cart.filter(item => item.name !== name);
        }
      } else if (change > 0) {
        cart.push({ name, price, qty: 1 });
      }

      // Reset payment status if cart changes significantly
      if (currentPayment && currentPayment.status === 'pending') {
          // Hanya beri peringatan, status pending tetap ada untuk jaga-jaga
          // alert("Keranjang berubah. Pastikan jumlah pembayaran sesuai.");
      }

      updateCart();
      renderMenu();
    }

    function updateCart() {
      const cartEl = document.getElementById('cart-items');
      const payBtn = document.getElementById('pay-btn');
      cartEl.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        cartEl.innerHTML = '<li style="color: #999; text-align: center;">Keranjang kosong.</li>';
        payBtn.disabled = true;
      } else {
        cart.forEach(item => {
          total += item.price * item.qty;
          const li = document.createElement('li');
          li.innerHTML = `
            <span>${item.name} (x${item.qty})</span>
            <span>${formatRupiah(item.price * item.qty)}</span>
          `;
          cartEl.appendChild(li);
        });

        const totalLi = document.createElement('li');
        totalLi.className = 'cart-total';
        totalLi.innerHTML = `<b>Total</b> <b>${formatRupiah(total)}</b>`;
        cartEl.appendChild(totalLi);

        payBtn.disabled = false;
        // checkoutBtn.disabled is handled by checkPaymentStatus
      }
    }

    // NEW FUNCTION: Render payment options dynamically
    function renderPaymentOptions(total) {
        const optionsEl = document.getElementById('payment-options');
        optionsEl.innerHTML = ''; // Clear previous options

        paymentMethods.forEach(method => {
            const button = document.createElement('button');
            button.className = 'btn-payment';
            button.style.backgroundColor = method.color;
            
            button.innerHTML = `
                <img src="${method.img}" alt="${method.name}" style="height: 25px; border-radius: 4px; background: white; padding: 2px;">
                <span>Bayar dengan ${method.name}</span>
            `;
            
            button.onclick = () => startPayment(method.name, total);
            
            optionsEl.appendChild(button);
        });
    }

    // NEW FUNCTION: Logic to start payment
    function startPayment(methodName, total) {
        const customerName = document.getElementById('customer-name').value.trim();
        
        if (!customerName) {
            alert("Silakan masukkan nama Anda terlebih dahulu.");
            closeModal('payment');
            return;
        }

        // Cek apakah sudah ada pembayaran pending yang sama untuk orang ini
        if (currentPayment && currentPayment.status === 'pending') {
             alert(`Anda sudah memulai pembayaran (${currentPayment.method}). Tunggu verifikasi atau batalkan dari kasir.`);
             closeModal('payment');
             return;
        }
        
        const paymentId = 'PAY-' + Date.now().toString().slice(-6); // Simple ID generator
        
        const paymentData = {
            id: paymentId,
            customerName: customerName, // SIMPAN NAMA PELANGGAN
            total: total,
            cart: [...cart],
            method: methodName, // SIMPAN METODE PEMBAYARAN
            status: 'pending',
            time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
        };

        let payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
        payments.unshift(paymentData);
        localStorage.setItem('pantryPayments', JSON.stringify(payments));

        currentPayment = paymentData; // Set the global payment state
        sessionStorage.setItem('lastPaymentId', paymentId); // Simpan ID agar persisten saat reload
        
        // Update UI
        document.getElementById('payment-status').innerHTML = `Menunggu verifikasi (${methodName}) <span style="color:orange;">⏳</span>`;
        document.getElementById('pay-btn').disabled = true;
        document.getElementById('checkout-btn').disabled = true;
        closeModal('payment');
        
        alert(`Pembayaran ${formatRupiah(total)} menggunakan ${methodName} oleh ${customerName} sedang menunggu verifikasi kasir. ID: ${paymentId}.`);
    }

    // UPDATED FUNCTION: Show payment modal
    function openPaymentModal() {
        if (cart.length === 0) return alert("Keranjang masih kosong!");
        
        const customerName = document.getElementById('customer-name').value.trim();
        if (!customerName) return alert("Silakan masukkan nama Anda terlebih dahulu.");
        
        const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
        document.getElementById('payment-total-display').textContent = formatRupiah(total);
        
        renderPaymentOptions(total);
        openModal('payment');
    }

    // UPDATED FUNCTION: Check payment status periodically
    function checkPaymentStatus() {
        const statusEl = document.getElementById('payment-status');
        const payBtn = document.getElementById('pay-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        if (!currentPayment) {
             statusEl.textContent = "Belum dibayar ❌";
             payBtn.disabled = (cart.length === 0);
             payBtn.style.display = 'block';
             checkoutBtn.disabled = true;
             return;
        }
        
        const payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
        const found = payments.find(p => p.id === currentPayment.id);
        
        if (found && found.status === 'paid') {
            currentPayment = found; // Update currentPayment status
            statusEl.innerHTML = `Berhasil dibayar (${found.method}) ✅`;
            checkoutBtn.disabled = false;
            payBtn.style.display = 'none'; 
            payBtn.disabled = true;
        } else if (found && found.status === 'pending') {
             currentPayment = found;
             statusEl.innerHTML = `Menunggu verifikasi (${found.method}) <span style="color:orange;">⏳</span>`;
             payBtn.disabled = true;
             payBtn.style.display = 'block';
             checkoutBtn.disabled = true;
        } else {
            // Payment cancelled or not found (e.g., after successful checkout)
            statusEl.textContent = "Belum dibayar ❌";
            payBtn.disabled = (cart.length === 0);
            payBtn.style.display = 'block';
            checkoutBtn.disabled = true;
            currentPayment = null;
            sessionStorage.removeItem('lastPaymentId');
        }
    }


    function checkout() {
      // 1. Check if payment is successful
      if (!currentPayment || !currentPayment.id) {
          return alert("Anda belum melakukan pembayaran!");
      }

      const payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
      const found = payments.find(p => p.id === currentPayment.id);
      if (!found || found.status !== "paid") return alert("Pembayaran belum diverifikasi oleh kasir!");

      const name = document.getElementById('customer-name').value.trim();
      if (!name) return alert("Masukkan nama Anda!");

      const order = {
        id: Date.now(),
        customerName: name,
        items: [...cart],
        total: cart.reduce((s, i) => s + i.price * i.qty, 0),
        status: 'Baru',
        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
        paymentId: currentPayment.id,
        paymentMethod: found.method // TAMBAH METODE PEMBAYARAN KE ORDER
      };

      const orders = JSON.parse(localStorage.getItem('pantryOrders')) || [];
      orders.unshift(order);
      localStorage.setItem('pantryOrders', JSON.stringify(orders));

      alert(`✅ Pesanan ${name} berhasil dibuat! Pembayaran ID: ${found.id} (${found.method}).`);
      cart = [];
      currentPayment = null;
      sessionStorage.removeItem('lastPaymentId');
      updateCart();
      renderMenu();
      document.getElementById('payment-status').textContent = "Belum dibayar ❌";
    }

    function openModal(t) { document.getElementById(t + "-modal").style.display = "block"; }
    function closeModal(t) { document.getElementById(t + "-modal").style.display = "none"; }
  </script>
</body>
</html>
