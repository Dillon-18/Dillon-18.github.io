<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pantry - Pemesanan Online</title>
  <link rel="stylesheet" href="index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="navbar">
    <div class="nav-left">
      <span class="brand-name">Pantry</span>
      <img src="Pantry Primary Logo-01.png" alt="Pantry Logo" class="brand-logo"> 
    </div>
    <div class="nav-right">
      <button class="nav-btn btn-secondary" onclick="openModal('contact')">Contact Me</button>
      <button class="nav-btn btn-secondary" onclick="openModal('info')">Info</button>
      <button class="nav-btn btn-primary" onclick="redirectToCashier()">Dashboard Kasir</button>
    </div>
  </header>
  
  <div class="container">
    <div class="content-grid">
        
        <div id="menu-section">
            <h2>Menu Makanan</h2>
            <div class="menu-list" id="menu-makanan"></div>

            <h2 style="margin-top: 30px;">Menu Minuman</h2>
            <div class="menu-list" id="menu-minuman"></div>
        </div>

        <div id="cart-section" class="sidebar">
            <h2 style="margin-top:0;">Keranjang Anda üõí</h2>
            <ul id="cart-items" class="cart-list">
                </ul>
            
            <div class="customer-info-box">
                <label for="customer-name">Nama Pelanggan:</label>
                <input type="text" id="customer-name" placeholder="Masukkan nama Anda">
            </div>

            <div class="payment-info">
                <p>Status Pembayaran:</p>
                <div id="payment-status" class="status-indicator">Belum dibayar ‚ùå</div>
                <button class="btn-primary" onclick="openPaymentModal()" id="bayar-btn">Pilih Pembayaran</button>
            </div>

            <button class="btn-primary btn-checkout" id="checkout-btn" disabled onclick="checkout()">Pesan</button>
        </div>
    </div>
  </div>

  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('payment')">&times;</span>
      <h3>Pilih Metode Pembayaran</h3>
      <p style="font-size:1.2em;">Total yang harus dibayar: <strong id="payment-total-display">Rp0</strong></p>
      <div id="payment-options" class="payment-options-list">
        </div>
    </div>
  </div>

  <div id="contact-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('contact')">&times;</span>
      <h3>Hubungi Saya</h3>
      <p>Jika ada masalah atau pertanyaan:</p>
      <p>Email: rjpm777@gmail.com</p>
      <p>WhatsApp: +62 821-1234-5678</p>
    </div>
  </div>

  <div id="info-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('info')">&times;</span>
      <h3>Info Sistem</h3>
      <p>Sistem Pemesanan Pantry dikembangkan menggunakan HTML, CSS, dan JavaScript murni (Local Storage & Session Storage) tanpa backend/database.</p>
      <p>Password Kasir: <strong>kasir123</strong></p>
    </div>
  </div>

  <script>
    const menuData = [
      { name: 'Nasi Goreng Spesial', price: 25000, category: 'makanan', img: 'nasgor.jpg' },
      { name: 'Mie Ayam Bakso', price: 20000, category: 'makanan', img: 'yamyam.jpg' },
      { name: 'Sate Ayam Madura', price: 30000, category: 'makanan', img: 'sate.jpg' },
      { name: 'Ayam Geprek Sambal Matah', price: 28000, category: 'makanan', img: 'ayamgeprek.jpg' },
      { name: 'Kwetiau Goreng Seafood', price: 27000, category: 'makanan', img: 'kwetiau.jpg' },
      { name: 'Soto Ayam Bening', price: 22000, category: 'makanan', img: 'soto.jpg' },
      { name: 'Beef Black Pepper', price: 35000, category: 'makanan', img: 'beefpepper.jpg' },
      { name: 'Capcay Kuah Sayur', price: 24000, category: 'makanan', img: 'capcay.jpg' },
      
      { name: 'Es Teh Manis', price: 8000, category: 'minuman', img: 'eses.jpg' },
      { name: 'Jus Alpukat', price: 15000, category: 'minuman', img: 'aalal.jpg' },
      { name: 'Kopi Susu Dingin', price: 12000, category: 'minuman', img: 'kopi.jpg' },
      { name: 'Teh Tarik Panas', price: 10000, category: 'minuman', img: 'tehtarik.jpg' },
      { name: 'Lemon Tea Dingin', price: 14000, category: 'minuman', img: 'lemontea.jpg' },
      { name: 'Milkshake Cokelat', price: 18000, category: 'minuman', img: 'milkshake.jpg' },
      { name: 'Air Mineral Botol', price: 5000, category: 'minuman', img: 'airmineral.jpg' },
      { name: 'Jus Mangga Segar', price: 16000, category: 'minuman', img: 'jusmangga.jpg' },
    ];

    const paymentMethods = [
      { name: 'GoPay', img: 'gopay.png', color: '#00A389' },
      { name: 'ShopeePay', img: 'shopeepay.png', color: '#FF5733' },
      { name: 'Dana', img: 'dana.png', color: '#1B72E5' },
      { name: 'Bank Transfer (BCA)', img: 'bca.png', color: '#004A99' },
    ];

    // FIX: Gunakan sessionStorage untuk persistensi data (cart, paymentId, name)
    let cart = JSON.parse(sessionStorage.getItem('pantryCart')) || [];
    let currentPaymentId = sessionStorage.getItem('currentPaymentId') || null;
    let customerName = sessionStorage.getItem('customerName') || '';

    document.addEventListener('DOMContentLoaded', () => {
      renderMenu();
      updateCart();
      checkPaymentStatus(); 
      setInterval(checkPaymentStatus, 2000); 
      
      // Muat nama pelanggan dari sesi ke input field
      document.getElementById('customer-name').value = customerName; 
    });

    function redirectToCashier() {
      const pass = prompt("Masukkan password kasir:");
      if (pass === "kasir123") {
        sessionStorage.setItem("cashierAuth", "true");
        window.location.href = "cashier.html";
      } else if (pass) alert("Password salah!");
    }

    // Fungsi untuk menyimpan nama pelanggan saat diinput (untuk persistensi)
    function updateCustomerName() {
        customerName = document.getElementById('customer-name').value.trim();
        sessionStorage.setItem('customerName', customerName);
    }
    document.getElementById('customer-name').addEventListener('input', updateCustomerName);


    function renderMenu() {
      const makanan = document.getElementById('menu-makanan');
      const minuman = document.getElementById('menu-minuman');
      makanan.innerHTML = '';
      minuman.innerHTML = '';

      menuData.forEach(item => {
        const exist = cart.find(i => i.name === item.name);
        const qty = exist ? exist.qty : 0;

        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <div class="menu-info">
            <div class="menu-name">${item.name}</div>
            <div class="menu-price">Rp${item.price.toLocaleString('id-ID')}</div>
          </div>
          <div class="menu-actions">
            <button class="btn-qty" onclick="changeMenuQty('${item.name}', ${item.price}, -1)">-</button>
            <div class="qty-display">${qty}</div>
            <button class="btn-qty btn-plus" onclick="changeMenuQty('${item.name}', ${item.price}, 1)">+</button>
          </div>`;
        if (item.category === 'makanan') makanan.appendChild(div);
        else minuman.appendChild(div);
      });
    }

    function changeMenuQty(name, price, delta) {
      const exist = cart.find(i => i.name === name);
      if (exist) {
        exist.qty += delta;
        if (exist.qty <= 0) cart = cart.filter(i => i.name !== name);
      } else if (delta > 0) cart.push({ name, price, qty: 1 });
      
      // Simpan keranjang ke sessionStorage
      sessionStorage.setItem('pantryCart', JSON.stringify(cart));

      updateCart();
      renderMenu();
    }

    function updateCart() {
      const list = document.getElementById('cart-items');
      const checkoutBtn = document.getElementById('checkout-btn');
      list.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        list.innerHTML = '<li style="color:#999;text-align:center;">Keranjang kosong.</li>';
      } else {
        cart.forEach((item) => {
          const subtotal = item.price * item.qty;
          total += subtotal;
          list.innerHTML += `<li>${item.name} - Rp${subtotal.toLocaleString('id-ID')} (${item.qty}x)</li>`;
        });
      }

      const totalRupiah = total.toLocaleString('id-ID');
      checkoutBtn.textContent = (total === 0) ? `Pesan` : `Pesan - Rp${totalRupiah}`;
      
      const isPaid = document.getElementById('payment-status').textContent.includes('‚úÖ');
      checkoutBtn.disabled = (total === 0 || !isPaid);
    }

    function openPaymentModal() {
      const name = document.getElementById('customer-name').value.trim();
      if (!name) return alert("Harap masukkan nama Anda terlebih dahulu di kolom 'Nama Pelanggan'.");
      if (cart.length === 0) return alert("Keranjang kosong!");
      
      const total = cart.reduce((s, i) => s + i.price * i.qty, 0);
      
      document.getElementById('payment-total-display').textContent = 'Rp' + total.toLocaleString('id-ID');
      
      const optionsEl = document.getElementById('payment-options');
      optionsEl.innerHTML = '';
      
      paymentMethods.forEach(method => {
          const btn = document.createElement('button');
          btn.textContent = `Bayar dengan ${method.name}`;
          btn.style.cssText = `
              background-color: ${method.color};
              color: white;
              padding: 12px;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-weight: 600;
              transition: opacity 0.2s;
          `;
          btn.onmouseover = () => btn.style.opacity = '0.9';
          btn.onmouseout = () => btn.style.opacity = '1';
          btn.onclick = () => selectPaymentMethod(method.name, total);
          optionsEl.appendChild(btn);
      });
      
      document.getElementById('payment-modal').style.display = 'block';
    }

    function selectPaymentMethod(methodName, total) {
      closeModal('payment');
      
      const name = document.getElementById('customer-name').value.trim();
      
      const code = "PAY" + Date.now();
      const newPayment = { 
          id: code, 
          customerName: name, // Menyimpan Nama Pelanggan ke Payment Object
          status: "pending", 
          total, 
          cart: [...cart], 
          time: new Date().toLocaleString('id-ID'),
          method: methodName 
      };

      // Simpan ID pembayaran ke session storage (FIX: persistensi)
      sessionStorage.setItem('currentPaymentId', code);
      currentPaymentId = code; 

      let payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
      payments.push(newPayment);
      localStorage.setItem('pantryPayments', JSON.stringify(payments));

      alert(`Anda memilih ${methodName} untuk ${name}. Total: Rp${total.toLocaleString('id-ID')}.\n\nSilakan tunggu kasir memverifikasi pembayaran Anda.`);

      checkPaymentStatus(); 
    }

    function checkPaymentStatus() {
      const checkoutBtn = document.getElementById('checkout-btn');
      const paymentStatusEl = document.getElementById('payment-status');
      
      if (!currentPaymentId) {
          paymentStatusEl.textContent = "Belum dibayar ‚ùå";
          checkoutBtn.disabled = true;
          return;
      }
      
      const payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
      const found = payments.find(p => p.id === currentPaymentId);

      // Reset status jika payment tidak lagi ada di local storage (bug fix)
      if (!found) {
          sessionStorage.removeItem('currentPaymentId');
          currentPaymentId = null;
          updateCart();
          paymentStatusEl.textContent = "Belum dibayar ‚ùå";
          return;
      }

      if (found && found.status === "paid") {
        paymentStatusEl.textContent = `Sudah dibayar (${found.method}) ‚úÖ`;
        const total = cart.reduce((s, i) => s + i.price * i.qty, 0);
        if (total > 0) {
          checkoutBtn.disabled = false;
        }
      } else {
        paymentStatusEl.textContent = "Menunggu verifikasi kasir... ‚è≥"; 
        checkoutBtn.disabled = true;
      }
    }

    function checkout() {
      const name = document.getElementById('customer-name').value.trim();
      if (!name) return alert("Masukkan nama Anda!");

      if (!currentPaymentId) return alert("Belum ada pembayaran!"); 

      const payments = JSON.parse(localStorage.getItem('pantryPayments')) || [];
      const found = payments.find(p => p.id === currentPaymentId); 

      if (!found || found.status !== "paid") return alert("Pembayaran belum diverifikasi oleh kasir!");

      const order = {
        id: Date.now(),
        customerName: name,
        items: [...cart],
        total: cart.reduce((s, i) => s + i.price * i.qty, 0),
        status: 'Baru',
        time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
        paymentId: currentPaymentId 
      };

      const orders = JSON.parse(localStorage.getItem('pantryOrders')) || [];
      orders.unshift(order);
      localStorage.setItem('pantryOrders', JSON.stringify(orders));

      alert(`‚úÖ Pesanan ${name} berhasil dibuat!`);
      cart = [];
      
      // Bersihkan semua data sesi setelah checkout berhasil
      currentPaymentId = null;
      customerName = '';
      sessionStorage.removeItem('currentPaymentId');
      sessionStorage.removeItem('pantryCart'); 
      sessionStorage.removeItem('customerName');
      document.getElementById('customer-name').value = '';

      updateCart();
      renderMenu();
      document.getElementById('payment-status').textContent = "Belum dibayar ‚ùå";
    }

    function openModal(t) { document.getElementById(t + "-modal").style.display = "block"; }
    function closeModal(t) { document.getElementById(t + "-modal").style.display = "none"; }
    window.onclick = e => { if (e.target.classList.contains('modal')) e.target.style.display = "none"; };
  </script>
</body>
</html>
